parameters:
  consumers: []
  skills: []

stages:
- ${{ each consumer in parameters.consumers }}:
  - ${{ each skill in parameters.skills }}:
    - stage: ${{ consumer.name }}_${{ skill.name }}
      jobs:
        - job: Configure
          steps:
            - ${{ if eq(consumer.configType, 'DotNet') }}:
              - task: AzureCLI@2
                displayName: 'Configure Host Bots Settings'
                inputs:
                  azureSubscription: $(AzureSubscription)
                  scriptType: ps
                  scriptLocation: inlineScript
                  inlineScript: |
                    az webapp config appsettings set -g ${{ consumer.resourceGroup }} -n ${{ consumer.botName }} --settings BotFrameworkSkills:0:AppId=${{ skill.appId }} BotFrameworkSkills:0:SkillEndpoint=https://${{ skill.botName }}.azurewebsites.net/api/messages SkillHostEndpoint=https://${{ consumer.botName }}.azurewebsites.net/api/skills

            - ${{ if eq(consumer.configType, 'Js') }}:
              - task: AzureCLI@2
                displayName: 'Configure Host Bots Settings'
                inputs:
                  azureSubscription: $(AzureSubscription)
                  scriptType: ps
                  scriptLocation: inlineScript
                  inlineScript: |
                    az webapp config appsettings set -g ${{ consumer.resourceGroup }} -n ${{ consumer.botName }} --settings SkillAppId=${{ skill.appId }} SkillEndpoint=https://${{ skill.botName }}.azurewebsites.net/api/messages SkillHostEndpoint=https://${{ consumer.botName }}.azurewebsites.net/api/skills

            - ${{ if eq(consumer.configType, 'Composer') }}:
              - task: AzureCLI@2
                displayName: 'Configure Host Bots Settings'
                inputs:
                  azureSubscription: $(AzureSubscription)
                  scriptType: ps
                  scriptLocation: inlineScript
                  inlineScript: |
                    az webapp config appsettings set -g ${{ consumer.resourceGroup }} -n ${{ consumer.botName }} --settings skill__EchoSkillBot__msAppId=${{ skill.appId }} skill__EchoSkillBot__endpointUrl=https://${{ skill.botName }}.azurewebsites.net/api/messages SkillHostEndpoint=https://${{ consumer.botName }}.azurewebsites.net/api/skills

        - job: Test
          dependsOn: Configure
          variables:
            HostBotName: ${{ consumer.botName }}
            Parameters.project: 'Tests/SkillFunctionalTests/SkillFunctionalTests.csproj'
            Parameters.solution: 'SkillFunctionalTests.sln'
            DefaultTestFilter: ''
            FilterParam: ${{ skill.testFilter }}
            TestFilter: $[ coalesce( variables['FilterParam'], variables['DefaultTestFilter'] ) ]
          steps:
          - template: runFunctionalTests.yml
            parameters:
              resourceGroup: ${{ consumer.resourceGroup }}
