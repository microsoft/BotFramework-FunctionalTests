parameters:
  resourceGroup: ''

steps:
- task: AzureCLI@2
  displayName: 'Set Bot Keys'
  inputs:
    azureSubscription: $(AzureSubscription)
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
     $result = az bot directline show -n "$(HostBotName)" -g "${{ parameters.resourceGroup }}" --with-secrets true | ConvertFrom-Json;
     $key = $result.properties.properties.sites.key;
     echo "##vso[task.setvariable variable=DIRECTLINE;]$key";
     echo "##vso[task.setvariable variable=BOTID;]$(HostBotName)";

- template: build.yml

- task: DotNetCoreCLI@2
  displayName: 'Dotnet Test'
  inputs:
    command: test
    projects: $(Parameters.project)
    arguments: '-v n  --configuration $(BuildConfiguration) --no-build --no-restore --filter TestCategory!=IgnoreInAutomatedBuild$(TestFilter)'
