parameters:
  resourceGroup: ''

steps:
- task: AzureCLI@1
  displayName: 'Get Bot Keys'
  inputs:
    azureSubscription: $(AzureSubscription)
    scriptLocation: inlineScript
    scriptType: ps
    inlineScript: |
      $result = call az bot directline show -n "$(HostBotName)" -g "${{ parameters.resourceGroup }}"--with-secrets true
      $json = $result | Out-String | ConvertFrom-Json;
      $key = $json.properties.properties.sites.key;
      echo "##vso[task.setvariable variable=DIRECTLINE;]$key";
      echo "##vso[task.setvariable variable=BOTID;]$(HostBotName)";

- template: build.yml

- task: DotNetCoreCLI@2
  displayName: 'Dotnet Test'
  inputs:
    command: test
    projects: $(Parameters.project)
    arguments: '-v n  --configuration $(BuildConfiguration) --no-build --no-restore --filter TestCategory!=IgnoreInAutomatedBuild$(TestFilter)'
