parameters:
  - name: azureSubscription
    displayName: Azure Service Connection
    type: string

  - name: resourceGroups
    displayName: Resource Groups
    type: object

stages:
- ${{ each resourceGroup in parameters.resourceGroups }}:
  - stage: "${{ resourceGroup.id }}"
    displayName: "${{ resourceGroup.displayName }}"
    dependsOn: [] # Makes this run in parallel
    jobs:
      - job: "Prepare"
        displayName: "Prepare steps"
        steps:
          - checkout: none

          - powershell: |
              Write-Host ("resourceGroup.name: " + "${{ resourceGroup.name }}");
              Write-Host ("parameters.azureSubscription: " + "${{ parameters.azureSubscription }}");
            displayName: "Show resource names"
            continueOnError: true

          - powershell: |
              Get-ChildItem env:* | sort-object name | Format-Table -AutoSize -Wrap;
            displayName: "Show env vars"
            continueOnError: true

          - template: ../../common/deleteResourceGroup.yml 
            parameters:
              azureSubscription: "${{ parameters.azureSubscription }}"
              name: "${{ resourceGroup.name }}"

          - task: AzureCLI@1
            displayName: "Create Resource Group"
            inputs:
              azureSubscription: "${{ parameters.azureSubscription }}"
              scriptLocation: inlineScript
              inlineScript: az group create --location westus --name "${{ resourceGroup.name }}"
